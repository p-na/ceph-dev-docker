#!/bin/bash

set -ex

find /ceph -iname '*.pyc' -delete
cd /ceph
git clone https://github.com/ceph/ceph . | true
./install-deps.sh

cmake_called=False
if [ ! -d /ceph/build ]; then
    # do_cmake.sh enables ccache by default if ccache is available
    ./do_cmake.sh -DWITH_PYTHON3=ON -DWITH_TESTS=OFF
    cmake_called=True
fi

cd /ceph/build

if [ "${cmake_called}" == "False" ]; then
    # Maybe use --force here as well?
    git submodule update --recursive
    cmake -DWITH_CCACHE=ON -DWITH_TESTS=OFF -DWITH_PYTHON3=ON ..
fi

if [ -z "$1" ]; then
	ccache make -j$(($(nproc)/2))  # By default use half of the available CPUs
else
	ccache make -j$1
fi
