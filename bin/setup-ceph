#!/bin/bash

set -ex

cd /ceph
git clone https://github.com/openattic/ceph . | true
./install-deps.sh

cmake_called=False
if [ ! -d /ceph/build ]; then
    # do_cmake.sh enables ccache by default if ccache is available
    ./do_cmake.sh -DWITH_PYTHON3=ON -DWITH_TESTS=OFF
    cmake_called=True
fi

cd /ceph/build

if [ "${cmake_called}" == "False" ] ; then
    # Maybe use --force here as well?
    git submodule update --recursive
    cmake -DWITH_CCACHE=ON -DWITH_TESTS=OFF -DWITH_PYTHON3=ON ..
fi
make -j$(nproc)

if which pip2; then
    pip2 install -r /ceph/src/pybind/mgr/${MGR_MODULE}/requirements.txt
fi
if which pip3; then
    pip3 install -r /ceph/src/pybind/mgr/${MGR_MODULE}/requirements.txt
fi
