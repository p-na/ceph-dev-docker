#!/bin/bash

set -ex

sudo zypper ref

# Improve rebuild time
export SOURCE_DATE_EPOCH=$(date +%U | date -f- +%s)

find /ceph -iname '*.pyc' -delete
cd /ceph
git clone https://github.com/ceph/ceph . | true
./install-deps.sh
CMAKE_ARGS="-D WITH_PYTHON3=ON -D WITH_TESTS=ON -D WITH_CCACHE=ON -D ENABLE_GIT_VERSION=OFF WITH_MGR_DASHBOARD_FRONTEND=OFF"

cmake_called=False
if [ ! -d /ceph/build ]; then
    # do_cmake.sh enables ccache by default if ccache is available
    ./do_cmake.sh $CMAKE_ARGS
    cmake_called=True
fi

cd /ceph/build

if [ "${cmake_called}" == "False" ]; then
    # Maybe use --force here as well?
    git submodule update --recursive --force --init
    cmake $CMAKE_ARGS ..
fi

if [ -z "$1" ]; then
	ccache make -j$(($(nproc)/2))  # By default use half of the available CPUs
else
	ccache make -j$1
fi
